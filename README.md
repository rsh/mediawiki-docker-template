# MediaWiki Docker Template

A template repository for deploying MediaWiki instances using Docker with MariaDB. This setup supports both development and production environments with a clean configuration structure.

## Features

- Docker-based setup with MariaDB
- Environment variable configuration via `.env`
- Secure password generation
- Backup and restore scripts
- Separate dev and production configurations
- Caddy reverse proxy support for production
- Smart startup script that handles first-time setup automatically

## Prerequisites

- Docker and Docker Compose installed
- Git (for cloning)
- Bash shell (Linux, macOS, or WSL on Windows)

## TL;DR - Get Started in 5 Commands

```bash
# 1. Clone and enter directory
git clone <your-repo-url> my-wiki && cd my-wiki

# 2. Setup (creates .env with all configuration)
./setup.sh "My Wiki Name"

# 3. Start (handles first-time setup automatically)
./start.sh

# 4. Complete the MediaWiki wizard in your browser, then:
cp ~/Downloads/LocalSettings.php instance/
./configure-localsettings.sh

# 5. Restart in normal mode
./start.sh
```

Done! Your wiki is running at `http://localhost:8080`

## Quick Start

### 1. Clone the Repository

```bash
# Clone this repository
git clone <your-repo-url> my-wiki
cd my-wiki
```

### 2. Run Setup Script

The setup script will create your `.env` file and generate secure credentials:

```bash
# Option 1: Interactive mode (will prompt for all settings)
./setup.sh

# Option 2: Quick mode with wiki name (can include spaces)
./setup.sh "My Personal Wiki"

# Option 3: Quick mode with multi-word name
./setup.sh "John's Project Wiki"
```

The script will:
- Accept wiki names with spaces (e.g., "My Personal Wiki")
- Automatically sanitize names for containers (e.g., "my-personal-wiki")
- Create database names with underscores (e.g., "my_personal_wiki")
- Prompt for development port and production domain
- Generate a secure random database password
- Create the `.env` file with all settings

**Note:** If `.env` already exists, the script will skip configuration and only generate a password if needed.

### 3. Start MediaWiki

The smart startup script automatically handles first-time setup vs normal operation:

```bash
# For local development
./start.sh

# For production (with Caddy reverse proxy)
./start.sh prod
```

**First Time Setup:** If `LocalSettings.php` doesn't exist, the script starts in setup mode and guides you through installation.

**Normal Operation:** If `LocalSettings.php` exists, the script starts your wiki normally.

### 4. Complete Installation (First Time Only)

When starting for the first time, the script will display:
- The URL to access the installation wizard
- All database credentials needed for setup

1. Visit the URL shown by the script
2. Follow the MediaWiki installation wizard
3. Use the database settings displayed by the script:
   - **Database host:** Shown by script (e.g., `{WIKI_NAME}-db`)
   - **Database name:** From your `.env`
   - **Database username:** From your `.env`
   - **Database password:** From your `.env`
4. Download the generated `LocalSettings.php`
5. Configure LocalSettings.php with the correct URLs:
   ```bash
   # Copy the downloaded file
   cp ~/Downloads/LocalSettings.php instance/

   # Configure server URL automatically
   ./configure-localsettings.sh          # For development
   # OR
   ./configure-localsettings.sh prod     # For production
   ```
6. Run `./start.sh` (or `./start.sh prod`) again - the script will detect the file and start normally

**What does configure-localsettings.sh do?**
- Sets `$wgServer` to the correct URL (localhost:port for dev, or your domain for prod)
- Updates `$wgDBserver` to use the correct container name
- Ensures your wiki URLs work correctly

## Environment Configuration

All instance-specific settings are configured in the `.env` file:

| Variable | Description | Example |
|----------|-------------|---------|
| `WIKI_NAME` | Used for container names | `my-wiki` |
| `WIKI_DISPLAY_NAME` | Display name in wiki interface | `My Personal Wiki` |
| `DB_NAME` | Database name | `my_wiki` |
| `DB_USER` | Database username | `wikiuser` |
| `DB_PASSWORD` | Database password (auto-generated by setup.sh) | `random-secure-password` |
| `DEV_PORT` | Development port | `8080` |
| `PROD_DOMAIN` | Production domain | `wiki.example.com` |

## Directory Structure

```
mediawiki-template/
├── .env.example                   # Template for environment variables
├── .env                           # Your configuration (gitignored, created by you)
├── setup.sh                       # Initial configuration script
├── start.sh                       # Smart startup script (handles first-time setup)
├── configure-localsettings.sh     # Helper to set wiki URLs in LocalSettings.php
├── docker-compose.yml             # Base configuration (shared)
├── docker-compose.override.yml    # Dev overrides (auto-loaded)
├── docker-compose.prod.yml        # Prod overrides (Caddy network)
├── docker-compose.init.yml        # Initial setup overrides (used by start.sh)
├── instance/                      # All MediaWiki data (gitignored)
│   ├── LocalSettings.php         # MediaWiki configuration
│   ├── db/                       # MariaDB database files
│   └── images/                   # Uploaded files
├── backup-mediawiki.sh            # Backup script
├── restore-backup.sh              # Restore script
├── clean.sh                       # Data cleanup script
├── teardown.sh                    # Complete removal script
├── check.sh                       # Script validation tool
└── README.md                      # This file
```

## Configuration Files (DRY Structure)

This setup uses Docker Compose's override pattern to avoid duplication:

### docker-compose.yml (Base)
- **Shared configuration** for both dev and prod
- Contains all common settings: images, volumes, environment variables, internal network
- Services use environment variables from `.env` for names and configuration

### docker-compose.override.yml (Development)
- **Automatically loaded** when you run `docker compose up -d`
- **Only** adds: Port mapping for direct localhost access (uses `DEV_PORT` from `.env`)
- **LocalSettings.php** should have: `$wgServer = "http://localhost:{DEV_PORT}";`

### docker-compose.prod.yml (Production)
- **Manually loaded** with: `docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d`
- **Only** adds: `caddy_network` (external network for reverse proxy)
- **No ports exposed** - access only through Caddy (more secure)
- **Requires**:
  1. `caddy_network` to exist: `docker network create caddy_network`
  2. Caddy configured with your domain
  3. **LocalSettings.php** updated: `$wgServer = "https://{PROD_DOMAIN}";`

### docker-compose.init.yml (Initial Setup)
- **Automatically used by `start.sh`** when LocalSettings.php doesn't exist
- **Overrides** the LocalSettings.php bind mount to allow first-time installation
- You typically don't need to use this file directly - just run `./start.sh`

## Maintenance

### Creating Backups

To backup your MediaWiki instance:

```bash
# Stop containers first for database consistency
docker compose down

# Create backup
./backup-mediawiki.sh

# Restart containers
docker compose up -d
```

This creates a timestamped `mediawiki-backup-YYYYMMDD_HHMMSS.tar.gz` file containing:
- LocalSettings.php
- Database files (db/)
- Uploaded images (images/)
- Any custom extensions/skins

**Important:** Store backups in a safe location outside this repository (e.g., `~/Backups/`, external drive, or cloud storage).

### Restoring from Backup

```bash
# Restore backup (will prompt to clean existing data)
./restore-backup.sh ~/Backups/mediawiki-backup-YYYYMMDD_HHMMSS.tar.gz

# Start containers
docker compose up -d
```

The restore script will:
1. Stop running containers
2. Clean existing data (with confirmation)
3. Extract backup files
4. Set proper permissions
5. Optionally update LocalSettings.php for development

### Migrating from Existing MediaWiki

If you have an existing MediaWiki instance to migrate:

1. **On your source server**, create a backup:
   ```bash
   # Copy backup script to source server
   scp backup-mediawiki.sh your-server:/path/to/mediawiki/

   # SSH and create backup
   ssh your-server
   cd /path/to/mediawiki
   docker compose down
   ./backup-mediawiki.sh
   docker compose up -d
   ```

2. **Download backup** to your local machine:
   ```bash
   scp your-server:/path/to/mediawiki/mediawiki-backup-*.tar.gz ~/Backups/
   ```

3. **Configure this template** with your settings:
   ```bash
   cp .env.example .env
   # Edit .env with your configuration
   ./setup.sh
   ```

4. **Restore the backup**:
   ```bash
   ./restore-backup.sh ~/Backups/mediawiki-backup-*.tar.gz
   ```

5. **Update LocalSettings.php** database connection settings to match your `.env`:
   ```php
   $wgDBserver = "{CONTAINER_DB_NAME}";  // e.g., "my-wiki-db"
   $wgDBname = "{DB_NAME}";              // from .env
   $wgDBuser = "{DB_USER}";              // from .env
   $wgDBpassword = "{DB_PASSWORD}";      // from .env
   ```

### Updating MediaWiki

```bash
# Pull the latest images
docker compose pull

# Restart with new images
docker compose up -d
```

### Database Management

To access the database directly:

```bash
# Connect to MariaDB (replace {CONTAINER_DB_NAME} with value from .env)
docker exec -it {CONTAINER_DB_NAME} mysql -u {DB_USER} -p
# Enter password from DB_PASSWORD in .env

# Use the database
USE {DB_NAME};
SHOW TABLES;
```

### Complete Teardown

To completely remove a wiki instance:

```bash
# This will remove all containers, networks, and data
./teardown.sh
```

**Warning:** This is irreversible! Make sure you have backups before running.

## Troubleshooting

### Database Connection Issues

If you see database errors:
1. Ensure the database container is running: `docker ps`
2. Check database exists: `docker exec -it {CONTAINER_DB_NAME} mysql -u {DB_USER} -p -e "SHOW DATABASES;"`
3. Verify `instance/LocalSettings.php` has correct credentials matching your `.env`
4. Ensure `$wgDBserver` in LocalSettings.php matches `CONTAINER_DB_NAME` from `.env`

### Missing Images

If images don't load:
1. Check `instance/images/` directory has content
2. Verify permissions are correct (set by restore script)
3. Check `$wgUploadPath` in LocalSettings.php

### Port Conflicts

If your dev port is in use:
1. Edit `.env` and change `DEV_PORT` to another port (e.g., `8081`)
2. Restart: `docker compose down && docker compose up -d`
3. Update `$wgServer` in `instance/LocalSettings.php` to match new port

### Database Won't Start

If the database container keeps restarting:
1. Check logs: `docker logs {CONTAINER_DB_NAME}`
2. Ensure `instance/db/` directory has correct permissions (775, group 999)
3. If corrupted, restore from backup

### Permission Issues

If you encounter permission errors:
1. Database directory needs group ownership by UID 999 (mysql)
2. Images directory needs group ownership by UID 33 (www-data)
3. The restore script sets these automatically, or manually run:
   ```bash
   sudo chown -R $(id -u):999 instance/db
   sudo chmod -R 775 instance/db
   sudo chown -R $(id -u):33 instance/images
   sudo find instance/images -type d -exec chmod 775 {} \;
   sudo find instance/images -type f -exec chmod 664 {} \;
   ```

## Production Deployment

When deploying to production with Caddy:

1. **Configure your `.env`** with production domain:
   ```bash
   PROD_DOMAIN=wiki.example.com
   ```

2. **Ensure the `caddy_network` exists**:
   ```bash
   docker network create caddy_network
   ```

3. **Configure Caddy** (Caddyfile) to reverse proxy to the wiki:
   ```
   {PROD_DOMAIN} {
       reverse_proxy {CONTAINER_MEDIAWIKI_NAME}:80
   }
   ```
   Replace variables with actual values from your `.env`.

4. **Update LocalSettings.php** with production URL:
   ```php
   $wgServer = "https://{PROD_DOMAIN}";
   ```

5. **Start the production stack**:
   ```bash
   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
   ```

**Tip:** Create a shell alias to simplify production commands:
```bash
alias dc-prod='docker compose -f docker-compose.yml -f docker-compose.prod.yml'
# Then use: dc-prod up -d, dc-prod down, dc-prod logs -f
```

## Security Best Practices

1. **Password Security**
   - Always run `setup.sh` to generate a secure random password
   - Never commit `.env` to version control (it's in `.gitignore`)
   - Change default passwords before going to production

2. **Backup Security**
   - Store backups in secure, off-site locations
   - Backups contain database credentials - protect them
   - Encrypt backups if storing in cloud services

3. **Network Security**
   - In production, never expose database ports
   - Use Caddy reverse proxy for HTTPS termination
   - Keep `LocalSettings.php` permissions restrictive (644)

4. **Repository Security**
   - The `.env` file is gitignored (contains secrets)
   - The `instance/` directory is gitignored (contains data and credentials)
   - Only configuration files and scripts are version controlled

## Quick Reference

### Development (Local)
```bash
# Start containers (use smart startup script)
./start.sh

# Access at: http://localhost:{DEV_PORT}

# Stop containers
docker compose down

# View logs
docker compose logs -f

# View logs for specific service
docker compose logs -f mediawiki
docker compose logs -f database
```

**Advanced:** If you prefer direct docker compose commands:
```bash
# Normal operation (when LocalSettings.php exists)
docker compose up -d

# First-time setup (when LocalSettings.php doesn't exist yet)
docker compose -f docker-compose.yml -f docker-compose.init.yml -f docker-compose.override.yml up -d
```

### Production (with Caddy)
```bash
# Start containers (use smart startup script)
./start.sh prod

# Access at: https://{PROD_DOMAIN} (through Caddy)

# Stop containers
docker compose down

# View logs
docker compose logs -f
```

**Advanced:** If you prefer direct docker compose commands:
```bash
# Normal operation (when LocalSettings.php exists)
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# First-time setup (when LocalSettings.php doesn't exist yet)
docker compose -f docker-compose.yml -f docker-compose.init.yml -f docker-compose.prod.yml up -d
```

## Creating Multiple Wiki Instances

This template makes it easy to run multiple independent wiki instances:

1. **Clone for each wiki**:
   ```bash
   git clone <repo> wiki-personal
   git clone <repo> wiki-work
   git clone <repo> wiki-project
   ```

2. **Configure each with unique settings**:
   ```bash
   cd wiki-personal
   ./setup.sh "Personal Wiki"
   # Use port 8080 when prompted

   cd ../wiki-work
   ./setup.sh "Work Wiki"
   # Use port 8081 when prompted

   cd ../wiki-project
   ./setup.sh "Project Documentation"
   # Use port 8082 when prompted
   ```

3. **Run all instances simultaneously**:
   ```bash
   cd wiki-personal && ./start.sh
   cd wiki-work && ./start.sh
   cd wiki-project && ./start.sh
   ```

Each instance is completely isolated with its own:
- Database and data
- Container names (no conflicts - automatically generated from wiki name)
- Port binding (you specify different ports during setup)
- Configuration

## Git Workflow

Only configuration files and scripts are committed to git:

```bash
# Add template files
git add .env.example *.sh docker-compose*.yml *.md .gitignore

# Commit
git commit -m "MediaWiki setup configuration"

# Push
git push
```

**Never commit:**
- `.env` (contains secrets)
- `instance/` directory (contains data and credentials)
- Backup files (`.tar.gz`)

These are automatically excluded by `.gitignore`.

## License

This template configuration is provided as-is for deploying MediaWiki instances.

## Support

For MediaWiki-specific issues, consult the [official MediaWiki documentation](https://www.mediawiki.org/wiki/Documentation).

For template issues, please open an issue in this repository.
